<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Search and Reviews</title>
</head>
<body>
    <h1>Search Manga</h1>
    <form id="searchForm">
        <label for="mangaTitle">Manga Title:</label>
        <input type="text" id="mangaTitle" name="mangaTitle" required>
        <button type="submit">Search</button>
    </form>

    <div id="mangaInfo">
        <h2 id="title"></h2>
        <p>Author: <span id="author"></span></p>
        <p>Genre: <span id="genre"></span></p>
        <p>Description: <span id="description"></span></p>
        <p>Rating: <span id="rating"></span></p>
    </div>

    <form id="ratingForm">
        <label><input type="radio" name="rating" value="1"> 1</label>
        <label><input type="radio" name="rating" value="2"> 2</label>
        <label><input type="radio" name="rating" value="3"> 3</label>
        <label><input type="radio" name="rating" value="4"> 4</label>
        <label><input type="radio" name="rating" value="5"> 5</label>
        <button type="submit">Submit Review</button>
      </form>
      
      <h2>Leave a Review</h2>
      <form id="reviewForm" style="display: none;">
        <label for="userName">Your Name:</label>
        <input type="text" id="userName" name="userName" required><br>
        
        <label for="reviewManga">Manga Title:</label>
        <input type="text" id="reviewManga" name="reviewManga" required><br>
        
        <label for="reviewText">Review:</label><br>
        <textarea id="reviewText" name="reviewText" rows="4" cols="50" required></textarea><br>
        
        <button type="submit">Submit Review</button>
      </form>
      
      <h1>Manga Reviews</h1>
      <div id="responseMessage"></div>
      <div id="reviewsContainer"></div>
    <script>
         document.getElementById("searchForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            try {
                const mangaTitle = document.getElementById("mangaTitle").value;
                const response = await fetch('/executeQuery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({sql: `exec spSearchManga @mangatitle='${mangaTitle}'`})
                });
                const responseData = await response.json();
                console.log(responseData);
                if (responseData.success) {
                    const manga = responseData.rows[0]; // Access the first row

                    // Set manga details using IDs
                    document.getElementById("title").innerText = manga.title;
                    document.getElementById("author").innerText = manga.author;
                    document.getElementById("genre").innerText = manga.genre;
                    document.getElementById("description").innerText = manga.description;
                    
                    // Show review form
                    document.getElementById("reviewForm").style.display = "block";

                } else {
                    document.getElementById("mangaInfo").innerText = 'Manga not found.';
                    // Hide review form if manga not found
                    document.getElementById("reviewForm").style.display = "none";
                }
            } catch (error) {
                console.error(error);
                document.getElementById("mangaInfo").innerText = 'Error searching for manga.';
            }
        });
        document.getElementById("searchForm").addEventListener("submit", async function(event) {
            event.preventDefault();
          
            try {
                const userName = 'me';
                const mangaName = document.getElementById("mangaTitle").value;
 
                const response = await fetch('/executeQuery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({sql: `exec GetRating @mangaName='${mangaName}',@userName='${userName}'`})
                   
                });
                
                const responseData = await response.json();
                console.log(responseData);
                if (responseData.success) {
                    const manga=responseData.rows[0];
                    document.getElementById("rating").innerText = manga.rating_count;
 } else {
                    throw new Error('Failed to retrieve rating for this manga.');
                }
            } catch (error) {
                console.error(error);
                document.getElementById("responseMessage").innerText = error.message;
            }
        });
        document.getElementById("ratingForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    try {
        const userName = 'me'; // For testing, you may want to replace this with dynamic input
        const mangaName = document.getElementById("mangaTitle").value;
        const selectedRating = document.querySelector('input[name="rating"]:checked');

        if (selectedRating) {
            const ratingValue = selectedRating.value;
            console.log("Selected Rating:", ratingValue);

            const response = await fetch('/executeQuery', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sql: `exec AddRating @mangaName='${mangaName}', @userName='${userName}', @ratingCount='${ratingValue}'`
                })
            });

            const responseData = await response.json();
            if (responseData.success) {
                console.log("Rating added successfully.");
                // Perform any further actions if needed
            } else {
                console.error("Failed to add rating.");
                // Handle failure scenarios
            }
        } else {
            console.error("Please select a rating.");
        }
    } catch (error) {
        console.error(error);
        alert('Rating not added. Please try again.');
    }
});

        document.addEventListener("DOMContentLoaded", function() {
    const ratingForm = document.getElementById("ratingForm");
    const ratingInputs = ratingForm.querySelectorAll("input[type='radio']");
    const reviewForm = document.getElementById("reviewForm");

    let selectedRating = null;

    // Event listener to detect changes in rating selection
    ratingInputs.forEach(function(input) {
      input.addEventListener("change", function() {
        selectedRating = this.value;
        console.log("Selected rating:", selectedRating);
      });
    });

    // Event listener for form submission
    reviewForm.addEventListener("submit", async function(event) {
      event.preventDefault();
      try {
        const userName = document.getElementById("userName").value;
        const mangaName = document.getElementById("reviewManga").value;
        const reviewText = document.getElementById("reviewText").value;

        const response = await fetch('/executeQuery', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sql: `exec AddRatingIfNotExists @mangaName='${mangaName}', @userName='${userName}', @ratingCount='${selectedRating}'`
          })
        });

        const responseData = await response.json();
        console.log(responseData);

        if (responseData.success) {
          // Optionally, clear the form fields after successful submission
          document.getElementById("userName").value = "";
          document.getElementById("reviewManga").value = "";
          document.getElementById("reviewText").value = "";

          // Fetch updated rating after adding the new rating
          fetchPreviousRatings(mangaName);
        }
      } catch (error) {
        console.error(error);
        alert('Failed to submit review. Please try again.');
      }
    });
  });

        document.getElementById("reviewForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    try {
        const userName = document.getElementById("userName").value;
        const mangaName = document.getElementById("reviewManga").value;
        const reviewText = document.getElementById("reviewText").value;

        const response = await fetch('/executeQuery', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sql: `exec AddComment @descrip='${reviewText}', @username='${userName}', @mangaName='${mangaName}'`
            })
        });

        const responseData = await response.json();
        console.log(responseData);

        if (responseData.success) {
            // Optionally, clear the form fields after successful submission
            document.getElementById("userName").value = '';
            document.getElementById("reviewManga").value = '';
            document.getElementById("reviewText").value = '';
        }
    } catch (error) {
        console.error(error);
        alert('Failed to submit review. Please try again.');
    }
});

        document.getElementById("searchForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    try {
        const mangaName = document.getElementById("mangaTitle").value;
        console.log(mangaName);
        const response = await fetch('/executeQuery', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({sql: `exec GetComments @mangaName='${mangaName}'`})
        });
        const responseData = await response.json();
        console.log(responseData);
        if (responseData.success) {
            const commentsData = responseData.rows;
            if (commentsData.length > 0) {
                const reviewsContainer = document.getElementById("reviewsContainer");
                reviewsContainer.innerHTML = ''; // Clear previous reviews
                commentsData.forEach(comment => {
                    const commentElement = document.createElement("div");
                    commentElement.innerHTML = `
                        <p><strong>User:</strong> ${comment.user_name}</p>
                        <p><strong>Comments:</strong> ${comment.descrip}</p>
                        <p><strong>Date:</strong> ${comment.date}</p>
                        <hr>
                    `;
                    reviewsContainer.appendChild(commentElement);
                });
            } else {
                throw new Error('No comments found for this manga.');
            }
        } else {
            throw new Error('Failed to retrieve manga comments.');
        }
    } catch (error) {
        console.error(error);
        document.getElementById("responseMessage").innerText = error.message;
    }
});
    </script>
</body>
</html>
